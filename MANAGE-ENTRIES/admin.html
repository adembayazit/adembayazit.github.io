async function handleMediaUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Dosya türü kontrolü
  if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
    showMessage('Sadece fotoğraf veya video yükleyebilirsiniz!', 'error');
    return;
  }
  
  try {
    showMessage('Dosya yükleniyor...', 'warning');
    showDebugInfo('Authentication parametreleri alınıyor...');
    
    // ImageKit.io authentication parametrelerini al
    const authResponse = await fetch('https://adembayazit.netlify.app/.netlify/functions/imagekit-auth');
    
    if (!authResponse.ok) {
      const errorText = await authResponse.text();
      throw new Error(`Auth endpoint hatası: ${authResponse.status} - ${errorText}`);
    }
    
    const authData = await authResponse.json();
    showDebugInfo('Auth data alındı: ' + JSON.stringify(authData).substring(0, 100) + '...');
    
    // FormData oluştur
    const formData = new FormData();
    formData.append('file', file);
    formData.append('fileName', file.name);
    formData.append('signature', authData.signature);
    formData.append('token', authData.token);
    formData.append('expire', authData.expire);
    formData.append('publicKey', authData.publicKey);
    
    showDebugInfo('ImageKit upload çağrısı yapılıyor...');
    // ImageKit.io'ya yükle
    const uploadResponse = await fetch('https://upload.imagekit.io/api/v1/files/upload', {
      method: 'POST',
      body: formData
    });
    
    showDebugInfo('Upload response alındı: ' + uploadResponse.status);
    
    if (!uploadResponse.ok) {
      const errorText = await uploadResponse.text();
      throw new Error(`Upload hatası: ${uploadResponse.status} - ${errorText}`);
    }
    
    const uploadData = await uploadResponse.json();
    showDebugInfo('Upload başarılı: ' + uploadData.url);
    
    // URL'yi ilgili textarea'ya ekle
    const textarea = document.getElementById(activeTextareaId);
    const url = uploadData.url;
    
    // Medya türüne göre embed kodu oluştur
    let mediaTag;
    if (file.type.startsWith('image/')) {
      mediaTag = `<img src="${url}" alt="Yüklenen resim" style="max-width: 100%; height: auto;">`;
    } else if (file.type.startsWith('video/')) {
      mediaTag = `<video src="${url}" controls style="max-width: 100%; height: auto;"></video>`;
    }
    
    // Textarea'ya ekle
    insertAtCursor(activeTextareaId, `\n${mediaTag}\n`);
    
    // Ön izlemeyi güncelle
    updatePreview(activeTextareaId);
    
    showMessage('Dosya başarıyla yüklendi!', 'success');
    showDebugInfo('');
  } catch (error) {
    console.error('Yükleme hatası:', error);
    let errorMessage = error.message || 'Bilinmeyen hata';
    
    // Daha anlaşılır hata mesajı
    if (errorMessage.includes('Failed to fetch')) {
      errorMessage = 'Sunucuya bağlanılamadı. Lütfen internet bağlantınızı kontrol edin.';
    } else if (errorMessage.includes('Unexpected token')) {
      errorMessage = 'Sunucudan beklenmeyen yanıt alındı. Lütfen yapılandırmayı kontrol edin.';
    } else if (errorMessage.includes('403')) {
      errorMessage = 'Yetkilendirme hatası. Lütfen API anahtarlarını kontrol edin.';
    }
    
    showMessage(`Yükleme hatası: ${errorMessage}`, 'error');
    showDebugInfo('Hata detayı: ' + errorMessage);
    
    // Alternatif yükleme seçeneği göster
    showAlternativeUploadOption();
  }
}
