<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>ImageKit Upload Test</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    input, button { margin: 5px 0; }
    #fileList img { max-width: 150px; margin: 5px; border: 1px solid #ccc; border-radius: 5px; }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

<h2>📤 ImageKit Test Sayfası</h2>
<input type="file" id="fileInput" accept="image/*" />
<button id="uploadBtn">Yükle</button>
<div id="status"></div>

<h3>📂 Yüklü Dosyalar</h3>
<button id="refreshBtn">Listeyi Yenile</button>
<div id="fileList"></div>

<script>
const uploadBtn = document.getElementById("uploadBtn");
const refreshBtn = document.getElementById("refreshBtn");
const statusDiv = document.getElementById("status");
const fileList = document.getElementById("fileList");

async function loadFiles() {
  fileList.innerHTML = "⏳ Liste alınıyor...";
  try {
    const res = await fetch("/.netlify/functions/ik-list");
    const files = await res.json();
    if (!Array.isArray(files)) { fileList.innerHTML = "❌ Hata"; return; }
    fileList.innerHTML = "";
    files.slice(0, 10).forEach(f => {
      const img = document.createElement("img");
      img.src = f.thumbnailUrl || f.url;
      img.title = f.name;
      fileList.appendChild(img);
    });
  } catch(e) {
    fileList.textContent = "❌ " + e.message;
  }
}

uploadBtn.addEventListener("click", async () => {
  const input = document.getElementById("fileInput");
  if(!input.files.length) return alert("Dosya seçin!");
  statusDiv.textContent = "⏳ Yükleniyor...";

  try {
    const auth = await fetch("/.netlify/functions/imagekit-auth").then(r => r.json());

    const formData = new FormData();
    formData.append("file", input.files[0]);
    formData.append("fileName", input.files[0].name);
    formData.append("token", auth.token);
    formData.append("expire", String(auth.expire));
    formData.append("signature", auth.signature);
    formData.append("publicKey", auth.publicKey);

    const res = await fetch("https://upload.imagekit.io/api/v2/files/upload", {
      method: "POST",
      body: formData
    });

    const data = await res.json();
    if (data.url) {
      statusDiv.innerHTML = `✅ Yüklendi: <a href="${data.url}" target="_blank">${data.name}</a>`;
      loadFiles();
    } else {
      statusDiv.textContent = "❌ Yükleme başarısız: " + JSON.stringify(data);
    }

  } catch (e) {
    statusDiv.textContent = "❌ Hata: " + e.message;
  }
});

refreshBtn.addEventListener("click", loadFiles);
loadFiles();
</script>

</body>
</html>
