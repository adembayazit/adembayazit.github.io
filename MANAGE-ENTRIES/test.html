<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ImageKit Upload</title>
</head>
<body>
<h2>Resim Yükle ve Önizle</h2>

<input type="file" id="fileInput" accept="image/*">
<button id="uploadBtn">Yükle</button>

<img id="preview" src="" style="max-width:300px; display:none;">
<p>Yüklenen Dosya: <a id="fileUrl" href="" target="_blank"></a></p>

<script>
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const preview = document.getElementById('preview');
const fileUrl = document.getElementById('fileUrl');

let selectedFile;

// Önizleme
fileInput.addEventListener('change', (e) => {
  selectedFile = e.target.files[0];
  if (selectedFile) {
    const reader = new FileReader();
    reader.onload = (event) => {
      preview.src = event.target.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(selectedFile);
  }
});

// Yükleme
uploadBtn.addEventListener('click', async () => {
  if(!selectedFile) return alert('Lütfen bir dosya seçin!');

  // 1️⃣ Netlify Function ile signature al
  const sigRes = await fetch('/.netlify/functions/get-upload-signature');
  const sigData = await sigRes.json();

  // 2️⃣ FormData hazırla
  const formData = new FormData();
  formData.append('file', selectedFile);
  formData.append('fileName', selectedFile.name);
  formData.append('publicKey', sigData.publicKey);
  formData.append('signature', sigData.signature);
  formData.append('expire', sigData.expire);
  formData.append('token', sigData.token);

  // 3️⃣ ImageKit’e yükle
  const uploadRes = await fetch('https://upload.imagekit.io/api/v1/files/upload', {
    method: 'POST',
    body: formData
  });

  const uploadData = await uploadRes.json();
  console.log(uploadData);

  if(uploadData.url){
    fileUrl.href = uploadData.url;
    fileUrl.textContent = uploadData.url;
  } else {
    alert('Yükleme başarısız!');
  }
});
</script>
</body>
</html>