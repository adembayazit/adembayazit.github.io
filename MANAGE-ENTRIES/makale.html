<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cybersecurity Articles Admin | Adem Bayazıt</title>
    <meta name="description" content="Makale yönetim paneli">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Cybersecurity Articles Admin" />
    <meta property="og:description" content="Makale yönetim paneli" />
    <meta property="og:type" content="website" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/IMAGES/ab.png">
    
    <!-- CSS Libraries -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/css/flag-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Quill Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
    
    <!-- Cropper.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    
    <style>
        :root {
            --primary-color: #00ff00;
            --primary-dark: #00cc00;
            --primary-light: #33ff33;
            --bg-color: #0a1916;
            --card-bg: rgba(10, 25, 20, 0.95);
            --text-color: #ffffff;
            --text-muted: #cccccc;
            --border-color: #00aa00;
            --highlight-color: #99ff99;
            --sidebar-width: 280px;
            --danger-color: #ff4444;
            --warning-color: #ffcc00;
            --success-color: #00cc66;
            --sidebar-collapsed: 70px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        html {
            font-size: 16px;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
            min-height: 100vh;
            width: 100%;
        }
        
        /* ... Diğer CSS kuralları aynı kalacak ... */
        
        /* Kapak fotoğrafı seçme alanı için özel stil */
        .cover-image-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .cover-image-preview {
            max-width: 100%;
            max-height: 300px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            margin-top: 10px;
            display: none;
            cursor: pointer;
        }
        
        .cover-image-preview.active {
            display: block;
        }
        
        .cover-image-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }
        
        .cover-image-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        /* Kırpma modalı için stiller */
        .crop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .crop-modal.active {
            display: flex;
        }
        
        .crop-modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            animation: modalIn 0.3s ease;
        }
        
        .crop-modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .crop-modal-title {
            color: var(--primary-color);
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .crop-modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow: auto;
        }
        
        .crop-container {
            width: 100%;
            height: 400px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        #cropImage {
            max-width: 100%;
            max-height: 100%;
        }
        
        .crop-modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .crop-size-info {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        
        /* ... Diğer CSS kuralları aynı kalacak ... */
        
        /* Son düzenleme tarihi için stil */
        .last-updated-info {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <!-- ... Login ekranı aynı kalacak ... -->

    <!-- Admin Panel -->
    <!-- ... Admin panel yapısı aynı kalacak ... -->

    <!-- Kırpma Modalı -->
    <div class="crop-modal" id="cropModal">
        <div class="crop-modal-content">
            <div class="crop-modal-header">
                <h3 class="crop-modal-title">Kapak Fotoğrafını Kırp</h3>
                <button class="modal-close" id="closeCropModal">&times;</button>
            </div>
            <div class="crop-modal-body">
                <div class="crop-size-info">
                    Önerilen boyut: 1200x630 piksel. Görselin orijinal boyutundan daha büyük bir alan seçemezsiniz.
                </div>
                <div class="crop-container">
                    <img id="cropImage" src="" alt="Kırpılacak görsel">
                </div>
            </div>
            <div class="crop-modal-footer">
                <button class="btn btn-danger" id="cancelCrop">İptal</button>
                <button class="btn btn-primary" id="cropImageBtn">Kırp ve Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Modal for Article Preview -->
    <!-- ... Diğer modal'lar aynı kalacak ... -->

    <!-- Scripts -->
    <!-- Quill Editor -->
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    
    <!-- Chart.js for Statistics (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <script>
        // Configuration
        const CONFIG = {
            ARTICLES_BIN_ID: '695f155c43b1c97be920c28d',
            SUBSCRIBERS_BIN_ID: '68d7fc3bae596e708ffdcc6e',
            ADMIN_PASSWORD_HASH: 'be408a40a5c6c0df48e0004b217dec97519da5e73876598203ec53bbe3ece5f7', // SHA256 of "admin"
            SESSION_TIMEOUT: 60 * 60 * 1000,
            DRAFT_AUTOSAVE_INTERVAL: 30000,
            IMAGEKIT_AUTH_ENDPOINT: 'https://adembayazit.netlify.app/.netlify/functions/imagekit-auth'
        };

        // Global Variables
        let articlesData = [];
        let subscribersData = [];
        let currentArticleId = null;
        let isEditing = false;
        let quillEN = null;
        let quillTR = null;
        let sessionTimer = null;
        let autoSaveTimer = null;
        let currentArticleTags = [];
        let uploadedImages = [];
        let selectedFiles = [];
        let isSidebarOpen = false;
        let activeEditor = null;
        let showUrlList = false;
        
        // Kırpma için değişkenler
        let cropper = null;
        let coverImageFile = null;
        let coverImagePreviewUrl = null;

        // SHA-256 Hash Function
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Toast Notification System
        function showToast(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            toast.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toastContainer.removeChild(toast), 300);
            }, duration);
        }

        // Modal Functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Kapak fotoğrafı kırpma fonksiyonları
        function initCoverImageCropping() {
            const coverImageInput = document.getElementById('featuredImage');
            const coverImagePreview = document.getElementById('coverImagePreview');
            const selectCoverImageBtn = document.getElementById('selectCoverImageBtn');
            const cropModal = document.getElementById('cropModal');
            const closeCropModal = document.getElementById('closeCropModal');
            const cancelCrop = document.getElementById('cancelCrop');
            const cropImageBtn = document.getElementById('cropImageBtn');
            
            // Kapak fotoğrafı önizleme alanına tıklanınca dosya seç
            if (coverImagePreview) {
                coverImagePreview.addEventListener('click', function() {
                    document.getElementById('coverImageFileInput').click();
                });
            }
            
            // Dosya seçme butonu
            if (selectCoverImageBtn) {
                selectCoverImageBtn.addEventListener('click', function() {
                    document.getElementById('coverImageFileInput').click();
                });
            }
            
            // Dosya seçildiğinde
            document.getElementById('coverImageFileInput').addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    
                    // Sadece resim dosyalarını kabul et
                    if (!file.type.match('image.*')) {
                        showToast('Lütfen sadece resim dosyası seçin', 'error');
                        return;
                    }
                    
                    // Max 5MB kontrolü
                    if (file.size > 5 * 1024 * 1024) {
                        showToast('Resim dosyası çok büyük (max 5MB)', 'error');
                        return;
                    }
                    
                    coverImageFile = file;
                    
                    // Önizleme göster
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        coverImagePreviewUrl = e.target.result;
                        openCropModal(coverImagePreviewUrl);
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Kırpma modalını aç
            function openCropModal(imageSrc) {
                const cropImage = document.getElementById('cropImage');
                cropImage.src = imageSrc;
                
                cropModal.classList.add('active');
                
                // Eski cropper'ı temizle
                if (cropper) {
                    cropper.destroy();
                }
                
                // Yeni cropper oluştur
                cropper = new Cropper(cropImage, {
                    aspectRatio: 1200 / 630,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    guides: true,
                    center: true,
                    background: false,
                    movable: true,
                    rotatable: false,
                    scalable: false,
                    zoomable: true,
                    zoomOnTouch: true,
                    zoomOnWheel: true,
                    wheelZoomRatio: 0.1,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                    minCanvasWidth: 100,
                    minCanvasHeight: 100,
                    minCropBoxWidth: 100,
                    minCropBoxHeight: 100,
                    ready: function() {
                        // Görselin orijinal boyutundan daha büyük kırpma yapılmasını engelle
                        const canvasData = cropper.getCanvasData();
                        const cropBoxData = cropper.getCropBoxData();
                        
                        // Kırpma kutusunun görsel alanından daha büyük olmamasını sağla
                        if (cropBoxData.width > canvasData.width) {
                            cropper.setCropBoxData({
                                width: canvasData.width
                            });
                        }
                        if (cropBoxData.height > canvasData.height) {
                            cropper.setCropBoxData({
                                height: canvasData.height
                            });
                        }
                    }
                });
            }
            
            // Modalı kapat
            function closeCropModalFunc() {
                cropModal.classList.remove('active');
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            }
            
            // Kapatma butonları
            if (closeCropModal) {
                closeCropModal.addEventListener('click', closeCropModalFunc);
            }
            
            if (cancelCrop) {
                cancelCrop.addEventListener('click', closeCropModalFunc);
            }
            
            // Kırpma butonu
            if (cropImageBtn) {
                cropImageBtn.addEventListener('click', async function() {
                    if (!cropper || !coverImageFile) {
                        showToast('Kırpılacak görsel bulunamadı', 'error');
                        return;
                    }
                    
                    try {
                        // Kırpılmış görseli al
                        const canvas = cropper.getCroppedCanvas({
                            width: 1200,
                            height: 630,
                            fillColor: '#fff',
                            imageSmoothingEnabled: true,
                            imageSmoothingQuality: 'high'
                        });
                        
                        if (!canvas) {
                            showToast('Kırpma işlemi başarısız', 'error');
                            return;
                        }
                        
                        // Canvas'ı blob'a çevir
                        canvas.toBlob(async function(blob) {
                            if (!blob) {
                                showToast('Görsel oluşturulamadı', 'error');
                                return;
                            }
                            
                            // Blob'dan dosya oluştur
                            const croppedFile = new File([blob], coverImageFile.name, {
                                type: coverImageFile.type,
                                lastModified: Date.now()
                            });
                            
                            // ImageKit'e yükle
                            const imageUrl = await uploadImageToImageKit(croppedFile);
                            
                            if (imageUrl) {
                                // Kapak fotoğrafı alanına URL'yi yaz
                                document.getElementById('featuredImage').value = imageUrl;
                                
                                // Önizlemeyi güncelle
                                const previewImg = document.getElementById('coverImagePreviewImg');
                                if (previewImg) {
                                    previewImg.src = imageUrl;
                                    document.getElementById('coverImagePreview').classList.add('active');
                                }
                                
                                showToast('Kapak fotoğrafı başarıyla yüklendi', 'success');
                                closeCropModalFunc();
                            }
                        }, coverImageFile.type);
                        
                    } catch (error) {
                        console.error('Kırpma hatası:', error);
                        showToast('Kırpma işlemi sırasında hata oluştu', 'error');
                    }
                });
            }
        }
        
        // ImageKit'e görsel yükleme fonksiyonu (kapak fotoğrafı için)
        async function uploadImageToImageKit(file) {
            try {
                // Authentication parametrelerini al
                const authResponse = await fetch(CONFIG.IMAGEKIT_AUTH_ENDPOINT);
                
                if (!authResponse.ok) {
                    throw new Error(`Auth endpoint error: ${authResponse.status}`);
                }
                
                const authData = await authResponse.json();
                
                // FormData oluştur
                const formData = new FormData();
                formData.append('file', file);
                formData.append('fileName', file.name);
                formData.append('signature', authData.signature);
                formData.append('token', authData.token);
                formData.append('expire', authData.expire);
                formData.append('publicKey', authData.publicKey);
                
                // ImageKit'e yükle
                const uploadResponse = await fetch('https://upload.imagekit.io/api/v1/files/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    throw new Error(`Upload error: ${uploadResponse.status} - ${errorText}`);
                }
                
                const uploadData = await uploadResponse.json();
                return uploadData.url;
                
            } catch (error) {
                console.error('Görsel yükleme hatası:', error);
                showToast('Görsel yüklenirken hata oluştu: ' + error.message, 'error');
                return null;
            }
        }

        // Confirm Dialog
        function showConfirm(message, callback) {
            document.getElementById('confirmMessage').textContent = message;
            showModal('confirmModal');
            
            document.getElementById('confirmAction').onclick = () => {
                hideModal('confirmModal');
                callback();
            };
            
            document.getElementById('cancelConfirm').onclick = () => hideModal('confirmModal');
            document.getElementById('closeConfirm').onclick = () => hideModal('confirmModal');
        }

        // Sidebar Management
        function toggleSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            isSidebarOpen = !isSidebarOpen;
            
            if (isSidebarOpen) {
                sidebar.classList.add('active');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            } else {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
            isSidebarOpen = false;
        }

        // Proxy Helper Function
        async function fetchViaProxy(path, method = 'GET', body = null, binId = null) {
            const proxyUrl = 'https://adembayazit.netlify.app/.netlify/functions/jsonbin-proxy';
            
            try {
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        path: binId ? `/b/${binId}${path}` : path,
                        method, 
                        body,
                        binId: binId
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Proxy error response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Debug için
                console.log(`Proxy ${method} ${binId}${path}:`, result);
                
                return result;
            } catch (error) {
                console.error('Proxy fetch error:', error);
                showToast('API bağlantı hatası', 'error');
                throw error;
            }
        }

        // Authentication Functions
        function checkAuth() {
            const auth = sessionStorage.getItem('adminAuth');
            const authTime = sessionStorage.getItem('adminAuthTime');
            
            if (auth && authTime) {
                const currentTime = new Date().getTime();
                if (currentTime - parseInt(authTime) < CONFIG.SESSION_TIMEOUT) {
                    return true;
                }
            }
            
            return false;
        }

        function setAuth() {
            sessionStorage.setItem('adminAuth', 'true');
            sessionStorage.setItem('adminAuthTime', new Date().getTime().toString());
            startSessionTimer();
        }

        function clearAuth() {
            sessionStorage.removeItem('adminAuth');
            sessionStorage.removeItem('adminAuthTime');
            if (sessionTimer) clearTimeout(sessionTimer);
        }

        function startSessionTimer() {
            if (sessionTimer) clearTimeout(sessionTimer);
            sessionTimer = setTimeout(() => {
                showToast('Oturum süreniz doldu. Lütfen tekrar giriş yapın.', 'warning');
                logout();
            }, CONFIG.SESSION_TIMEOUT);
        }

        async function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!password) {
                errorDiv.textContent = 'Lütfen şifre girin';
                errorDiv.style.display = 'block';
                return;
            }
            
            const hash = await sha256(password);
            
            if (hash === CONFIG.ADMIN_PASSWORD_HASH) {
                setAuth();
                showAdminPanel();
                showToast('Başarıyla giriş yapıldı', 'success');
            } else {
                errorDiv.textContent = 'Hatalı şifre!';
                errorDiv.style.display = 'block';
                document.getElementById('adminPassword').value = '';
                document.getElementById('adminPassword').focus();
            }
        }

        function logout() {
            clearAuth();
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
            closeSidebar();
        }

        // Navigation Functions
        function setupNavigation() {
            // Sidebar navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;
                    
                    // Update active states
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show selected section
                    document.querySelectorAll('.section-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(section).classList.add('active');
                    
                    // Close sidebar on mobile
                    if (window.innerWidth <= 992) {
                        closeSidebar();
                    }
                    
                    // Load section data if needed
                    switch(section) {
                        case 'dashboard':
                            loadDashboard();
                            break;
                        case 'articles':
                            loadArticlesList();
                            break;
                        case 'subscribers':
                            loadSubscribers();
                            break;
                        case 'email':
                            loadEmailSection();
                            break;
                    }
                });
            });
            
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // Update active tabs
                    document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show selected tab content
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId + 'Tab').classList.add('active');
                });
            });
            
            // New article button
            document.getElementById('newArticleBtn')?.addEventListener('click', function() {
                resetEditor();
                switchToSection('editor');
            });
            
            // Hamburger button
            document.getElementById('hamburgerBtn')?.addEventListener('click', toggleSidebar);
            document.getElementById('sidebarOverlay')?.addEventListener('click', closeSidebar);
        }

        function switchToSection(sectionId) {
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
                if (nav.dataset.section === sectionId) {
                    nav.classList.add('active');
                }
            });
            document.querySelectorAll('.section-content').forEach(content => content.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            if (window.innerWidth <= 992) {
                closeSidebar();
            }
        }

        // Tab switching function
        function switchToTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === tabName + 'Tab') {
                    content.classList.add('active');
                }
            });
        }

        // Insert image to editor function
        function insertImageToEditor(imageUrl) {
            let editor = activeEditor;
            if (!editor) {
                editor = quillEN;
            }

            if (editor === quillEN || editor === quillTR) {
                const range = editor.getSelection();
                if (range) {
                    editor.insertEmbed(range.index, 'image', imageUrl);
                } else {
                    editor.insertEmbed(editor.getLength(), 'image', imageUrl);
                }
                showToast('Görsel editöre eklendi', 'success');
            } else {
                showToast('Editör bulunamadı', 'error');
            }
        }

        // Data Loading Functions
        async function loadArticles() {
            try {
                console.log('Loading articles from Bin:', CONFIG.ARTICLES_BIN_ID);
                const result = await fetchViaProxy('/latest', 'GET', null, CONFIG.ARTICLES_BIN_ID);
                console.log('Raw articles result:', result);
                
                if (Array.isArray(result)) {
                    articlesData = result;
                } else if (result && result.articles && Array.isArray(result.articles)) {
                    articlesData = result.articles;
                } else if (result && result.records && Array.isArray(result.records)) {
                    articlesData = result.records;
                } else if (result && result.data && Array.isArray(result.data)) {
                    articlesData = result.data;
                } else {
                    console.warn('Unexpected data format, initializing empty array');
                    articlesData = [];
                }
                
                console.log('Parsed articlesData:', articlesData);
                
                // Sort by date (newest first)
                articlesData.sort((a, b) => {
                    const dateA = new Date(a.published_date || a.date || 0);
                    const dateB = new Date(b.published_date || b.date || 0);
                    return dateB - dateA;
                });
                
                return true;
            } catch (error) {
                console.error('Error loading articles:', error);
                showToast('Makaleler yüklenirken hata oluştu. Daha sonra tekrar deneyin.', 'error');
                articlesData = [];
                return false;
            }
        }

        // Subscribers Loading Function
        async function loadSubscribers() {
            try {
                console.log('Loading subscribers from Bin:', CONFIG.SUBSCRIBERS_BIN_ID);
                const result = await fetchViaProxy('/latest', 'GET', null, CONFIG.SUBSCRIBERS_BIN_ID);
                console.log('Raw subscribers result:', result);
                
                let loadedData = [];
                
                if (Array.isArray(result)) {
                    loadedData = result.map(item => {
                        if (typeof item === 'string') {
                            return { 
                                email: item, 
                                subscribedAt: new Date().toISOString(),
                                status: 'active' 
                            };
                        }
                        return item;
                    });
                } else if (result && result.subscribers && Array.isArray(result.subscribers)) {
                    loadedData = result.subscribers.map(item => {
                        if (typeof item === 'string') {
                            return { 
                                email: item, 
                                subscribedAt: new Date().toISOString(),
                                status: 'active' 
                            };
                        }
                        return item;
                    });
                } else if (result && result.emails && Array.isArray(result.emails)) {
                    loadedData = result.emails.map(item => ({
                        email: item,
                        subscribedAt: new Date().toISOString(),
                        status: 'active'
                    }));
                } else if (result && result.data && Array.isArray(result.data)) {
                    loadedData = result.data;
                }
                
                subscribersData = loadedData;
                console.log('Parsed subscribersData:', subscribersData);
                
                // Update UI
                document.getElementById('emailStats').textContent = `${subscribersData.length} abone`;
                document.getElementById('subscribersCount').textContent = `${subscribersData.length} abone`;
                document.getElementById('totalSubscribers').textContent = subscribersData.length;
                
                // Render subscribers table
                renderSubscribersTable();
                
                return true;
            } catch (error) {
                console.error('Error loading subscribers:', error);
                showToast('Aboneler yüklenirken hata oluştu. Daha sonra tekrar deneyin.', 'error');
                subscribersData = [];
                return false;
            }
        }

        function renderSubscribersTable() {
            const tbody = document.getElementById('subscribersTableBody');
            tbody.innerHTML = '';
            
            if (subscribersData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center" style="padding: 40px; color: var(--text-muted);">
                            Henüz abone bulunmuyor
                        </td>
                    </tr>
                `;
                return;
            }
            
            subscribersData.forEach((subscriber, index) => {
                const row = document.createElement('tr');
                const date = subscriber.subscribedAt 
                    ? new Date(subscriber.subscribedAt).toLocaleDateString('tr-TR')
                    : new Date().toLocaleDateString('tr-TR');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${subscriber.email}</td>
                    <td>${date}</td>
                    <td><span class="badge badge-success">${subscriber.status || 'Aktif'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-danger btn-sm" onclick="removeSubscriber('${subscriber.email}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function removeSubscriber(email) {
            showConfirm(`${email} adresini abonelikten çıkarmak istediğinizden emin misiniz?`, async function() {
                try {
                    // Filter out the subscriber
                    subscribersData = subscribersData.filter(s => s.email !== email);
                    
                    // Save to JSON Bin
                    const dataToSave = {
                        subscribers: subscribersData,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    await fetchViaProxy('', 'PUT', dataToSave, CONFIG.SUBSCRIBERS_BIN_ID);
                    
                    showToast('Abone kaldırıldı', 'success');
                    loadSubscribers();
                } catch (error) {
                    console.error('Error removing subscriber:', error);
                    showToast('Abone kaldırılırken hata oluştu', 'error');
                }
            });
        }

        // Dashboard Functions
        async function loadDashboard() {
            await Promise.all([loadArticles(), loadSubscribers()]);
            
            // Update stats
            const totalArticles = articlesData.length;
            const totalViews = articlesData.reduce((sum, article) => sum + (article.views || 0), 0);
            const totalLikes = articlesData.reduce((sum, article) => sum + (article.likes || 0), 0);
            const totalSubscribers = subscribersData.length;
            const avgReadingTime = articlesData.length > 0 
                ? Math.round(articlesData.reduce((sum, article) => sum + (article.reading_time || 5), 0) / articlesData.length)
                : 0;
            const lastArticleDate = articlesData.length > 0 
                ? new Date(articlesData[0].published_date || articlesData[0].date).toLocaleDateString('tr-TR')
                : '-';
            
            document.getElementById('totalArticles').textContent = totalArticles;
            document.getElementById('totalViews').textContent = totalViews.toLocaleString();
            document.getElementById('totalLikes').textContent = totalLikes.toLocaleString();
            document.getElementById('totalSubscribers').textContent = totalSubscribers.toLocaleString();
            document.getElementById('avgReadingTime').textContent = avgReadingTime;
            document.getElementById('lastArticleDate').textContent = lastArticleDate;
            document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString('tr-TR');
            
            // Load recent articles
            loadRecentArticles();
        }

        function loadRecentArticles() {
            const tbody = document.getElementById('recentArticles');
            const recentArticles = articlesData.slice(0, 5);
            
            tbody.innerHTML = '';
            
            if (recentArticles.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center" style="padding: 40px; color: var(--text-muted);">
                            Henüz makale bulunmuyor
                        </td>
                    </tr>
                `;
                return;
            }
            
            recentArticles.forEach(article => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${article.title}
                    </td>
                    <td>${article.category || '-'}</td>
                    <td>${date}</td>
                    <td>${article.views || 0}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-info btn-sm" onclick="editArticle(${article.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="previewArticle(${article.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Articles List Functions
        async function loadArticlesList() {
            await loadArticles();
            
            const tbody = document.getElementById('articlesTableBody');
            tbody.innerHTML = '';
            
            if (articlesData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center" style="padding: 40px; color: var(--text-muted);">
                            Henüz makale bulunmuyor
                        </td>
                    </tr>
                `;
                return;
            }
            
            articlesData.forEach(article => {
                const row = document.createElement('tr');
                const date = new Date(article.published_date || article.date).toLocaleDateString('tr-TR');
                
                row.innerHTML = `
                    <td>${article.id}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        ${article.title}
                    </td>
                    <td>${article.category || '-'}</td>
                    <td>${date}</td>
                    <td>${article.views || 0}</td>
                    <td>${article.likes || 0}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-info btn-sm" onclick="editArticle(${article.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="previewArticle(${article.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteArticle(${article.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateEmailArticleSelect();
        }

        // Image Upload Functions
        function setupImageUpload() {
            const uploadArea = document.getElementById('imageUploadArea');
            const fileInput = document.getElementById('imageUpload');
            
            // Tıklama ile dosya seç
            uploadArea.addEventListener('click', (e) => {
                if (e.target !== uploadArea && !uploadArea.contains(e.target)) return;
                fileInput.click();
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--primary-color)';
                uploadArea.style.background = 'rgba(0, 255, 0, 0.05)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = 'var(--border-color)';
                uploadArea.style.background = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--border-color)';
                uploadArea.style.background = '';
                
                if (e.dataTransfer.files.length) {
                    handleFileSelection(e.dataTransfer.files);
                }
            });
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFileSelection(e.target.files);
                }
            });
            
            // Upload images button
            document.getElementById('uploadImagesBtn').addEventListener('click', uploadImagesToImageKit);
            
            // Clear images button
            document.getElementById('clearImagesBtn').addEventListener('click', clearSelectedImages);
            
            // Toggle URL list button
            document.getElementById('toggleUrlListBtn').addEventListener('click', toggleUrlList);
            
            // Track active editor for image insertion
            if (quillEN) {
                quillEN.on('selection-change', function(range, oldRange, source) {
                    if (range) activeEditor = quillEN;
                });
            }
            
            if (quillTR) {
                quillTR.on('selection-change', function(range, oldRange, source) {
                    if (range) activeEditor = quillTR;
                });
            }
        }

        function handleFileSelection(files) {
            for (let file of files) {
                if (!file.type.startsWith('image/')) {
                    showToast(`${file.name} bir resim dosyası değil`, 'error');
                    continue;
                }

                if (file.size > 5 * 1024 * 1024) {
                    showToast(`${file.name} çok büyük (max 5MB)`, 'error');
                    continue;
                }

                // Create preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedFiles.push({
                        file: file,
                        preview: e.target.result,
                        id: Date.now() + Math.random()
                    });
                    updateImagePreview();
                    showToast(`${file.name} seçildi`, 'info');
                };
                reader.readAsDataURL(file);
            }
        }

        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = '';
            
            const allImages = [...selectedFiles, ...uploadedImages.map(url => ({ 
                preview: url, 
                id: 'uploaded_' + Date.now() + Math.random(),
                isUploaded: true 
            }))];
            
            if (allImages.length === 0) {
                preview.innerHTML = `
                    <p style="color: var(--text-muted); text-align: center; padding: 20px; grid-column: 1 / -1;">
                        Henüz görsel yüklenmedi. Görselleri yükledikten sonra burada görünecekler.
                    </p>
                `;
                return;
            }
            
            allImages.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'preview-item';
                
                const img = document.createElement('img');
                img.src = item.preview;
                img.alt = `Preview ${index + 1}`;
                
                const removeBtn = document.createElement('div');
                removeBtn.className = 'preview-remove';
                removeBtn.innerHTML = '&times;';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    if (item.isUploaded) {
                        // Remove from uploaded images
                        const urlIndex = uploadedImages.indexOf(item.preview);
                        if (urlIndex > -1) {
                            uploadedImages.splice(urlIndex, 1);
                            updateUrlList();
                        }
                    } else {
                        // Remove from selected files
                        const fileIndex = selectedFiles.findIndex(f => f.id === item.id);
                        if (fileIndex > -1) {
                            selectedFiles.splice(fileIndex, 1);
                        }
                    }
                    updateImagePreview();
                    showToast('Görsel kaldırıldı', 'info');
                });

                itemDiv.appendChild(img);
                itemDiv.appendChild(removeBtn);

                // Eğer görsel ImageKit'e yüklenmişse, editöre ekle butonunu göster
                if (item.isUploaded) {
                    const insertBtn = document.createElement('div');
                    insertBtn.className = 'preview-insert';
                    insertBtn.innerHTML = '<i class="fas fa-plus"></i>';
                    insertBtn.title = "Editöre ekle";
                    insertBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        insertImageToEditor(item.preview);
                    });
                    itemDiv.appendChild(insertBtn);
                    
                    // Eğer bu görsel kapak görseli ise, işaretle
                    if (document.getElementById('featuredImage').value === item.preview) {
                        const coverBadge = document.createElement('div');
                        coverBadge.className = 'preview-cover';
                        coverBadge.textContent = 'KAPAK';
                        itemDiv.appendChild(coverBadge);
                    }
                }

                // Görsele tıklayınca kapak görseli olarak ayarla
                itemDiv.addEventListener('click', (e) => {
                    if (e.target !== removeBtn && !removeBtn.contains(e.target) && 
                        e.target !== insertBtn && !insertBtn.contains(e.target)) {
                        document.getElementById('featuredImage').value = item.preview;
                        updateImagePreview();
                        showToast('Kapak görseli olarak seçildi', 'info');
                    }
                });

                preview.appendChild(itemDiv);
            });
            
            // URL listesini güncelle
            updateUrlList();
        }

        // ImageKit Upload Function
        async function uploadImagesToImageKit() {
            if (selectedFiles.length === 0) {
                showToast('Yüklenecek görsel bulunamadı', 'warning');
                return;
            }

            const uploadBtn = document.getElementById('uploadImagesBtn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yükleniyor...';

            let successCount = 0;
            let errorCount = 0;

            for (const item of selectedFiles) {
                try {
                    showToast(`${item.file.name} yükleniyor...`, 'info');
                    
                    // Önce authentication parametrelerini al
                    const authResponse = await fetch(CONFIG.IMAGEKIT_AUTH_ENDPOINT);
                    
                    if (!authResponse.ok) {
                        throw new Error(`Auth endpoint error: ${authResponse.status}`);
                    }
                    
                    const authData = await authResponse.json();
                    
                    // FormData oluştur
                    const formData = new FormData();
                    formData.append('file', item.file);
                    formData.append('fileName', item.file.name);
                    formData.append('signature', authData.signature);
                    formData.append('token', authData.token);
                    formData.append('expire', authData.expire);
                    formData.append('publicKey', authData.publicKey);
                    
                    // ImageKit'e yükle
                    const uploadResponse = await fetch('https://upload.imagekit.io/api/v1/files/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        const errorText = await uploadResponse.text();
                        throw new Error(`Upload error: ${uploadResponse.status} - ${errorText}`);
                    }
                    
                    const uploadData = await uploadResponse.json();
                    
                    // Add to uploaded images
                    uploadedImages.push(uploadData.url);
                    successCount++;
                    
                    showToast(`${item.file.name} başarıyla yüklendi`, 'success');
                    
                } catch (error) {
                    console.error('Error uploading image:', error);
                    errorCount++;
                    showToast(`${item.file.name} yüklenirken hata: ${error.message}`, 'error');
                    
                    // Hata durumunda alternative upload seçeneği göster
                    if (errorCount === selectedFiles.length) {
                        showAlternativeUploadOption();
                    }
                }
            }

            // Clear selected files after upload
            selectedFiles = [];
            updateImagePreview();

            uploadBtn.disabled = false;
            uploadBtn.innerHTML = originalText;

            if (successCount > 0) {
                showToast(`${successCount} görsel başarıyla yüklendi${errorCount > 0 ? `, ${errorCount} başarısız` : ''}`, 
                         errorCount > 0 ? 'warning' : 'success');
            }
        }

        // FIXED: Direct ImageKit upload from Quill editor
        async function uploadImageToImageKitFromQuill(file, editor) {
            try {
                // Önce authentication parametrelerini al
                const authResponse = await fetch(CONFIG.IMAGEKIT_AUTH_ENDPOINT);
                
                if (!authResponse.ok) {
                    throw new Error(`Auth endpoint error: ${authResponse.status}`);
                }
                
                const authData = await authResponse.json();
                
                // FormData oluştur
                const formData = new FormData();
                formData.append('file', file);
                formData.append('fileName', file.name);
                formData.append('signature', authData.signature);
                formData.append('token', authData.token);
                formData.append('expire', authData.expire);
                formData.append('publicKey', authData.publicKey);
                
                // ImageKit'e yükle
                const uploadResponse = await fetch('https://upload.imagekit.io/api/v1/files/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    throw new Error(`Upload error: ${uploadResponse.status} - ${errorText}`);
                }
                
                const uploadData = await uploadResponse.json();
                
                // Add to uploaded images
                uploadedImages.push(uploadData.url);
                
                // Insert into editor at cursor position
                const range = editor.getSelection();
                if (range) {
                    editor.insertEmbed(range.index, 'image', uploadData.url);
                } else {
                    editor.insertEmbed(editor.getLength(), 'image', uploadData.url);
                }
                
                showToast('Görsel yüklendi ve editöre eklendi', 'success');
                return uploadData.url;
                
            } catch (error) {
                console.error('Error uploading image from Quill:', error);
                showToast('Görsel yüklenirken hata oluştu: ' + error.message, 'error');
                throw error;
            }
        }

        function clearSelectedImages() {
            if (selectedFiles.length > 0 || uploadedImages.length > 0) {
                showConfirm('Tüm seçili görselleri temizlemek istediğinizden emin misiniz?', function() {
                    selectedFiles = [];
                    uploadedImages = [];
                    document.getElementById('featuredImage').value = '';
                    updateImagePreview();
                    updateUrlList();
                    showToast('Görseller temizlendi', 'info');
                });
            } else {
                showToast('Temizlenecek görsel yok', 'info');
            }
        }

        // URL list functions
        function updateUrlList() {
            const urlList = document.getElementById('urlList');
            urlList.innerHTML = '';
            
            if (uploadedImages.length === 0) {
                document.getElementById('urlListContainer').style.display = 'none';
                return;
            }
            
            uploadedImages.forEach((url, index) => {
                const urlItem = document.createElement('div');
                urlItem.className = 'url-item';
                
                const urlText = document.createElement('span');
                urlText.textContent = url;
                
                const urlActions = document.createElement('div');
                urlActions.className = 'url-actions';
                
                const copyBtn = document.createElement('button');
                copyBtn.className = 'btn btn-info btn-sm';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                copyBtn.title = "URL'yi kopyala";
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(url).then(() => {
                        showToast('URL kopyalandı', 'success');
                    });
                });
                
                const insertBtn = document.createElement('button');
                insertBtn.className = 'btn btn-primary btn-sm';
                insertBtn.innerHTML = '<i class="fas fa-plus"></i>';
                insertBtn.title = "Editöre ekle";
                insertBtn.addEventListener('click', () => {
                    insertImageToEditor(url);
                });
                
                const setCoverBtn = document.createElement('button');
                setCoverBtn.className = 'btn btn-success btn-sm';
                setCoverBtn.innerHTML = '<i class="fas fa-image"></i>';
                setCoverBtn.title = "Kapak görseli yap";
                setCoverBtn.addEventListener('click', () => {
                    document.getElementById('featuredImage').value = url;
                    updateImagePreview();
                    showToast('Kapak görseli olarak ayarlandı', 'success');
                });
                
                urlActions.appendChild(copyBtn);
                urlActions.appendChild(insertBtn);
                urlActions.appendChild(setCoverBtn);
                
                urlItem.appendChild(urlText);
                urlItem.appendChild(urlActions);
                urlList.appendChild(urlItem);
            });
            
            if (showUrlList) {
                document.getElementById('urlListContainer').style.display = 'block';
            }
        }

        function toggleUrlList() {
            showUrlList = !showUrlList;
            const urlListContainer = document.getElementById('urlListContainer');
            const toggleBtn = document.getElementById('toggleUrlListBtn');
            
            if (showUrlList && uploadedImages.length > 0) {
                urlListContainer.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> URL\'leri Gizle';
                showToast('URL listesi gösteriliyor', 'info');
            } else {
                urlListContainer.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> URL\'leri Göster';
                if (showUrlList) {
                    showToast('URL listesi gizlendi', 'info');
                }
            }
        }

        // Alternative upload option
        function showAlternativeUploadOption() {
            const imagesTab = document.getElementById('imagesTab');
            const alternativeHtml = `
                <div class="alternative-upload">
                    <p>Alternatif olarak, dosyayı manuel olarak yükleyip URL ekleyebilirsiniz:</p>
                    <p><a href="https://imagekit.io/dashboard/media-library" target="_blank">ImageKit Media Library</a></p>
                </div>
            `;
            
            if (!imagesTab.querySelector('.alternative-upload')) {
                imagesTab.insertAdjacentHTML('beforeend', alternativeHtml);
            }
        }

        // Article Editor Functions
        function initEditor() {
            // Custom image handler for Quill that uploads directly to ImageKit
            const ImageHandler = {
                // Create a hidden file input
                createFileInput: function(editor) {
                    const fileInput = document.createElement('input');
                    fileInput.setAttribute('type', 'file');
                    fileInput.setAttribute('accept', 'image/*');
                    fileInput.style.display = 'none';
                    
                    fileInput.addEventListener('change', async function() {
                        if (this.files && this.files[0]) {
                            const file = this.files[0];
                            
                            // Validate file type
                            if (!file.type.startsWith('image/')) {
                                showToast('Lütfen bir resim dosyası seçin', 'error');
                                return;
                            }
                            
                            // Validate file size (5MB)
                            if (file.size > 5 * 1024 * 1024) {
                                showToast('Resim dosyası çok büyük (max 5MB)', 'error');
                                return;
                            }
                            
                            // Set active editor
                            activeEditor = editor;
                            
                            // Show loading message
                            const originalRange = editor.getSelection();
                            const loadingText = `[Görsel yükleniyor: ${file.name}...]`;
                            
                            if (originalRange) {
                                editor.insertText(originalRange.index, loadingText);
                            }
                            
                            try {
                                // Upload to ImageKit
                                const imageUrl = await uploadImageToImageKitFromQuill(file, editor);
                                
                                // Remove loading text
                                if (originalRange) {
                                    editor.deleteText(originalRange.index, loadingText.length);
                                }
                                
                                // Already inserted in uploadImageToImageKitFromQuill
                                return;
                                
                            } catch (error) {
                                // Remove loading text on error
                                if (originalRange) {
                                    editor.deleteText(originalRange.index, loadingText.length);
                                }
                                showToast('Görsel yüklenemedi: ' + error.message, 'error');
                            }
                            
                            // Reset file input
                            fileInput.value = '';
                        }
                    });
                    
                    document.body.appendChild(fileInput);
                    return fileInput;
                }
            };

            // Initialize Quill editors with custom image handler
            const toolbarOptions = [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link', 'image', 'code-block'],
                ['clean']
            ];

            // İngilizce editörü oluştur
            quillEN = new Quill('#editorEN', {
                theme: 'snow',
                modules: {
                    toolbar: {
                        container: toolbarOptions,
                        handlers: {
                            'image': function() {
                                // Create file input for this editor
                                const fileInput = ImageHandler.createFileInput(quillEN);
                                fileInput.click();
                            }
                        }
                    }
                },
                placeholder: 'İngilizce içeriği buraya yazın...'
            });

            // Türkçe editörü oluştur
            quillTR = new Quill('#editorTR', {
                theme: 'snow',
                modules: {
                    toolbar: {
                        container: toolbarOptions,
                        handlers: {
                            'image': function() {
                                // Create file input for this editor
                                const fileInput = ImageHandler.createFileInput(quillTR);
                                fileInput.click();
                            }
                        }
                    }
                },
                placeholder: 'Türkçe içeriği buraya yazın (isteğe bağlı)...'
            });
            
            // Track active editor
            quillEN.on('selection-change', function(range, oldRange, source) {
                if (range) {
                    activeEditor = quillEN;
                }
            });

            quillTR.on('selection-change', function(range, oldRange, source) {
                if (range) {
                    activeEditor = quillTR;
                }
            });
            
            // Set default publish date to now
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('publishDate').value = localDateTime;
            
            // Setup tag system
            setupTagSystem();
            
            // Setup image upload
            setupImageUpload();
            
            // Setup autosave
            setupAutoSave();
            
            // Setup cover image cropping
            initCoverImageCropping();
        }

        function setupTagSystem() {
            document.getElementById('addTagBtn').addEventListener('click', addTag);
            document.getElementById('tagInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag();
                }
            });
        }

        function addTag() {
            const tagInput = document.getElementById('tagInput');
            const tag = tagInput.value.trim();
            
            if (tag && !currentArticleTags.includes(tag)) {
                currentArticleTags.push(tag);
                renderTags();
                tagInput.value = '';
                tagInput.focus();
            }
        }

        function removeTag(index) {
            currentArticleTags.splice(index, 1);
            renderTags();
        }

        function renderTags() {
            const container = document.getElementById('tagsContainer');
            container.innerHTML = '';
            
            currentArticleTags.forEach((tag, index) => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag';
                tagElement.innerHTML = `
                    ${tag}
                    <span class="tag-remove" onclick="removeTag(${index})">&times;</span>
                `;
                container.appendChild(tagElement);
            });
        }

        function setupAutoSave() {
            if (autoSaveTimer) clearInterval(autoSaveTimer);
            autoSaveTimer = setInterval(saveDraft, CONFIG.DRAFT_AUTOSAVE_INTERVAL);
            window.addEventListener('beforeunload', saveDraft);
        }

        function saveDraft() {
            const articleData = getArticleFormData();
            
            if (articleData.title || articleData.content) {
                localStorage.setItem('articleDraft', JSON.stringify({
                    ...articleData,
                    tags: currentArticleTags,
                    uploadedImages: uploadedImages,
                    savedAt: new Date().toISOString()
                }));
                
                const saveBtn = document.getElementById('saveDraftBtn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-check"></i> Kaydedildi';
                saveBtn.style.background = 'var(--success-color)';
                
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                }, 2000);
            }
        }

        function loadDraft() {
            const draft = localStorage.getItem('articleDraft');
            if (draft) {
                try {
                    const draftData = JSON.parse(draft);
                    
                    if (draftData.title || draftData.content) {
                        if (confirm('Kaydedilmemiş bir taslak bulundu. Yüklemek ister misiniz?')) {
                            document.getElementById('articleTitle').value = draftData.title || '';
                            document.getElementById('articleTitleTR').value = draftData.title_tr || '';
                            document.getElementById('articleCategory').value = draftData.category || '';
                            document.getElementById('articleAuthor').value = draftData.author || 'Adem Bayazıt';
                            document.getElementById('featuredImage').value = draftData.featured_image || '';
                            document.getElementById('seoTitle').value = draftData.seo_title || '';
                            document.getElementById('seoDescription').value = draftData.seo_description || '';
                            document.getElementById('readingTime').value = draftData.reading_time || 5;
                            document.getElementById('publishDate').value = draftData.publish_date || '';
                            document.getElementById('featuredArticle').checked = draftData.featured || false;
                            
                            if (quillEN && draftData.content) quillEN.root.innerHTML = draftData.content;
                            if (quillTR && draftData.content_tr) quillTR.root.innerHTML = draftData.content_tr;
                            
                            currentArticleTags = draftData.tags || [];
                            uploadedImages = draftData.uploadedImages || [];
                            
                            renderTags();
                            updateImagePreview();
                            
                            // Kapak fotoğrafı önizlemesini güncelle
                            if (draftData.featured_image) {
                                const previewImg = document.getElementById('coverImagePreviewImg');
                                if (previewImg) {
                                    previewImg.src = draftData.featured_image;
                                    document.getElementById('coverImagePreview').classList.add('active');
                                }
                            }
                            
                            showToast(`Taslak yüklendi (${new Date(draftData.savedAt).toLocaleTimeString('tr-TR')})`, 'info');
                        }
                    }
                } catch (error) {
                    console.error('Error loading draft:', error);
                    localStorage.removeItem('articleDraft');
                }
            }
        }

        function resetEditor() {
            currentArticleId = null;
            isEditing = false;
            currentArticleTags = [];
            uploadedImages = [];
            selectedFiles = [];
            activeEditor = null;
            showUrlList = false;
            coverImageFile = null;
            coverImagePreviewUrl = null;
            
            // Reset form
            document.getElementById('articleTitle').value = '';
            document.getElementById('articleTitleTR').value = '';
            document.getElementById('articleCategory').value = '';
            document.getElementById('articleAuthor').value = 'Adem Bayazıt';
            document.getElementById('featuredImage').value = '';
            document.getElementById('seoTitle').value = '';
            document.getElementById('seoDescription').value = '';
            document.getElementById('readingTime').value = 5;
            document.getElementById('publishDate').value = new Date().toISOString().slice(0, 16);
            document.getElementById('featuredArticle').checked = false;
            
            // Reset editors
            if (quillEN) quillEN.root.innerHTML = '';
            if (quillTR) quillTR.root.innerHTML = '';
            
            // Reset tags and images
            renderTags();
            updateImagePreview();
            document.getElementById('urlListContainer').style.display = 'none';
            document.getElementById('toggleUrlListBtn').innerHTML = '<i class="fas fa-eye"></i> URL\'leri Göster';
            
            // Kapak fotoğrafı önizlemesini sıfırla
            const previewImg = document.getElementById('coverImagePreviewImg');
            if (previewImg) {
                previewImg.src = '';
                document.getElementById('coverImagePreview').classList.remove('active');
            }
            
            // Update UI
            document.querySelector('#editor .section-title').innerHTML = '<i class="fas fa-edit"></i> Yeni Makale';
        }

        // FIXED: Preserve likes and views when editing articles
        function getArticleFormData() {
            // Mevcut makalenin görüntülenme ve beğeni sayılarını koru
            let existingArticle = null;
            if (isEditing && currentArticleId) {
                existingArticle = articlesData.find(a => a.id == currentArticleId);
            }
            
            return {
                id: currentArticleId || (articlesData.length > 0 ? Math.max(...articlesData.map(a => parseInt(a.id) || 0)) + 1 : 1),
                title: document.getElementById('articleTitle').value.trim(),
                title_tr: document.getElementById('articleTitleTR').value.trim() || null,
                content: quillEN?.root.innerHTML || '',
                content_tr: quillTR?.root.innerHTML || null,
                category: document.getElementById('articleCategory').value,
                author: document.getElementById('articleAuthor').value.trim(),
                featured_image: document.getElementById('featuredImage').value.trim() || null,
                seo_title: document.getElementById('seoTitle').value.trim() || null,
                seo_description: document.getElementById('seoDescription').value.trim() || null,
                tags: currentArticleTags,
                reading_time: parseInt(document.getElementById('readingTime').value) || 5,
                published_date: document.getElementById('publishDate').value || new Date().toISOString(),
                featured: document.getElementById('featuredArticle').checked,
                images: uploadedImages,
                // FIXED: Görüntüleme ve beğeni sayılarını koru
                views: existingArticle ? (existingArticle.views || 0) : 0,
                likes: existingArticle ? (existingArticle.likes || 0) : 0,
                comments_count: existingArticle ? (existingArticle.comments_count || 0) : 0
            };
        }

        // Save Article Function - FIXED: Preserve stats when saving
        // DEĞİŞİKLİK: Son düzenleme tarihi ekleme
        async function saveArticle(publish = false) {
            const articleData = getArticleFormData();
            
            // Validate required fields
            if (!articleData.title) {
                showToast('Makale başlığı gereklidir', 'error');
                document.getElementById('articleTitle').focus();
                return false;
            }
            
            if (!articleData.content) {
                showToast('Makale içeriği gereklidir', 'error');
                return false;
            }
            
            if (!articleData.category) {
                showToast('Kategori gereklidir', 'error');
                document.getElementById('articleCategory').focus();
                return false;
            }
            
            try {
                // Mevcut verileri yükle
                await loadArticles();
                
                // Eğer yayınlama işlemiyse, son düzenleme tarihini ekle
                if (publish) {
                    const now = new Date();
                    const formattedDate = now.toLocaleDateString('tr-TR', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // Son düzenleme tarihini içeriğin en altına ekle
                    const lastUpdatedHtml = `<div class="last-updated-info">Last updated: ${formattedDate}</div>`;
                    
                    // İngilizce içeriğe ekle
                    if (articleData.content) {
                        // Eğer zaten son düzenleme tarihi varsa onu kaldır
                        articleData.content = articleData.content.replace(/<div class="last-updated-info">[\s\S]*?<\/div>/g, '');
                        articleData.content += lastUpdatedHtml;
                    }
                    
                    // Türkçe içeriğe ekle (eğer varsa)
                    if (articleData.content_tr) {
                        // Eğer zaten son düzenleme tarihi varsa onu kaldır
                        articleData.content_tr = articleData.content_tr.replace(/<div class="last-updated-info">[\s\S]*?<\/div>/g, '');
                        articleData.content_tr += lastUpdatedHtml;
                    }
                }
                
                let updatedArticles;
                if (isEditing && currentArticleId) {
                    // FIXED: Update existing article - görüntüleme ve beğeni sayılarını koru
                    const index = articlesData.findIndex(a => a.id == currentArticleId);
                    if (index !== -1) {
                        // Mevcut makaleden görüntüleme ve beğeni sayılarını al
                        const existingViews = articlesData[index].views || 0;
                        const existingLikes = articlesData[index].likes || 0;
                        const existingComments = articlesData[index].comments_count || 0;
                        
                        // Yeni verilerle birleştir, ancak görüntüleme ve beğeni sayılarını koru
                        articlesData[index] = { 
                            ...articlesData[index], 
                            ...articleData,
                            views: existingViews,
                            likes: existingLikes,
                            comments_count: existingComments
                        };
                        console.log('Updated article with preserved stats:', articlesData[index]);
                    }
                    updatedArticles = articlesData;
                } else {
                    // Add new article
                    console.log('Adding new article:', articleData);
                    articlesData.unshift(articleData);
                    updatedArticles = articlesData;
                }
                
                // JSON Bin formatı
                const dataToSave = {
                    articles: updatedArticles,
                    lastUpdated: new Date().toISOString()
                };
                
                console.log('Saving to JSON Bin:', dataToSave);
                
                // Save to JSON Bin
                await fetchViaProxy('', 'PUT', dataToSave, CONFIG.ARTICLES_BIN_ID);
                
                // Clear draft
                localStorage.removeItem('articleDraft');
                
                // Yerel veriyi güncelle
                articlesData = updatedArticles;
                
                // Show success message
                showToast(`Makale ${publish ? 'yayınlandı' : 'kaydedildi'}`, 'success');
                
                // Reset editor if publishing
                if (publish) {
                    resetEditor();
                    switchToSection('articles');
                    loadArticlesList();
                }
                
                return true;
            } catch (error) {
                console.error('Error saving article:', error);
                showToast('Makale kaydedilirken hata oluştu: ' + error.message, 'error');
                return false;
            }
        }

        function editArticle(id) {
            const article = articlesData.find(a => a.id == id);
            if (!article) {
                showToast('Makale bulunamadı', 'error');
                return;
            }
            
            currentArticleId = id;
            isEditing = true;
            
            // Fill form with article data
            document.getElementById('articleTitle').value = article.title || '';
            document.getElementById('articleTitleTR').value = article.title_tr || '';
            document.getElementById('articleCategory').value = article.category || '';
            document.getElementById('articleAuthor').value = article.author || 'Adem Bayazıt';
            document.getElementById('featuredImage').value = article.featured_image || '';
            document.getElementById('seoTitle').value = article.seo_title || '';
            document.getElementById('seoDescription').value = article.seo_description || '';
            document.getElementById('readingTime').value = article.reading_time || 5;
            
            // Format date for datetime-local input
            const publishDate = new Date(article.published_date || article.date);
            const localDateTime = new Date(publishDate.getTime() - publishDate.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('publishDate').value = localDateTime;
            
            document.getElementById('featuredArticle').checked = article.featured || false;
            
            // Set editor content
            if (quillEN) quillEN.root.innerHTML = article.content || '';
            if (quillTR) quillTR.root.innerHTML = article.content_tr || '';
            
            // Set tags and images
            currentArticleTags = article.tags || [];
            uploadedImages = article.images || [];
            
            renderTags();
            updateImagePreview();
            
            // Kapak fotoğrafı önizlemesini güncelle
            if (article.featured_image) {
                const previewImg = document.getElementById('coverImagePreviewImg');
                if (previewImg) {
                    previewImg.src = article.featured_image;
                    document.getElementById('coverImagePreview').classList.add('active');
                }
            }
            
            // Navigate to editor
            switchToSection('editor');
            document.querySelector('#editor .section-title').innerHTML = `<i class="fas fa-edit"></i> Makaleyi Düzenle: ${article.title.substring(0, 30)}...`;
        }

        function deleteArticle(id) {
            showConfirm('Bu makaleyi silmek istediğinizden emin misiniz?', async function() {
                try {
                    await loadArticles();
                    articlesData = articlesData.filter(a => a.id != id);
                    
                    const dataToSave = {
                        articles: articlesData,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    await fetchViaProxy('', 'PUT', dataToSave, CONFIG.ARTICLES_BIN_ID);
                    
                    showToast('Makale silindi', 'success');
                    loadArticlesList();
                    
                    // If we're editing this article, reset editor
                    if (currentArticleId == id) {
                        resetEditor();
                    }
                } catch (error) {
                    console.error('Error deleting article:', error);
                    showToast('Makale silinirken hata oluştu', 'error');
                }
            });
        }

        function previewArticle(id) {
            const article = articlesData.find(a => a.id == id);
            if (!article) return;
            
            const modalContent = document.getElementById('previewModalContent');
            modalContent.innerHTML = `
                <h3>${article.title}</h3>
                ${article.title_tr ? `<h4>${article.title_tr}</h4>` : ''}
                <p><strong>Kategori:</strong> ${article.category}</p>
                <p><strong>Yazar:</strong> ${article.author}</p>
                <p><strong>Tarih:</strong> ${new Date(article.published_date || article.date).toLocaleDateString('tr-TR')}</p>
                <p><strong>Görüntülenme:</strong> ${article.views || 0}</p>
                <p><strong>Beğeni:</strong> ${article.likes || 0}</p>
                <p><strong>Okuma Süresi:</strong> ${article.reading_time || 5} dakika</p>
                <hr>
                <div>${article.content}</div>
                ${article.content_tr ? `<hr><h4>Türkçe İçerik:</h4><div>${article.content_tr}</div>` : ''}
            `;
            
            showModal('previewModal');
        }

        // Email Functions
        function updateEmailArticleSelect() {
            const select = document.getElementById('emailArticleSelect');
            select.innerHTML = '<option value="">Makale seçin</option>';
            
            articlesData.forEach(article => {
                const option = document.createElement('option');
                option.value = article.id;
                option.textContent = `${article.id} - ${article.title.substring(0, 50)}${article.title.length > 50 ? '...' : ''}`;
                select.appendChild(option);
            });
        }

        async function loadEmailSection() {
            await loadArticles();
            await loadSubscribers();
            
            updateEmailArticleSelect();
            document.getElementById('emailStats').textContent = `${subscribersData.length} abone`;
        }

        async function sendEmailToSubscribers(testOnly = false) {
            const articleId = document.getElementById('emailArticleSelect').value;
            const subject = document.getElementById('emailSubject').value.trim();
            const template = document.getElementById('emailTemplate').value;
            const customMessage = document.getElementById('customMessage').value.trim();
            const testEmail = document.getElementById('testEmail').value.trim();
            
            if (!articleId) {
                showToast('Lütfen bir makale seçin', 'error');
                return;
            }
            
            if (!subject) {
                showToast('Email başlığı gereklidir', 'error');
                return;
            }
            
            const article = articlesData.find(a => a.id == articleId);
            if (!article) {
                showToast('Makale bulunamadı', 'error');
                return;
            }
            
            let recipients = testOnly ? [testEmail] : subscribersData.map(s => s.email);
            
            if (recipients.length === 0) {
                showToast(testOnly ? 'Test email adresi gerekli' : 'Gönderilecek abone bulunmuyor', 'error');
                return;
            }
            
            if (testOnly && !testEmail.includes('@')) {
                showToast('Geçerli bir test email adresi girin', 'error');
                return;
            }
            
            try {
                const btnId = testOnly ? 'testEmailBtn' : 'sendEmailBtn';
                const btn = document.getElementById(btnId);
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gönderiliyor...';
                
                // Create email data
                const emailData = {
                    Messages: [{
                        From: {
                            Email: "fyi@adembayazit.com",
                            Name: "Adem Bayazıt - Cybersecurity Articles"
                        },
                        To: recipients.map(email => ({ Email: email })),
                        Subject: subject.replace('{article_title}', article.title),
                        HTMLPart: generateEmailTemplate(article, customMessage, template),
                        TextPart: generateTextTemplate(article, customMessage)
                    }]
                };
                
                // Send email via Netlify function
                const response = await fetch('https://adembayazit.netlify.app/.netlify/functions/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        emailData: emailData
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                showToast(testOnly 
                    ? `Test email gönderildi: ${testEmail}`
                    : `Email ${recipients.length} aboneye gönderildi`,
                    'success'
                );
                
                if (!testOnly) {
                    document.getElementById('customMessage').value = '';
                }
                
            } catch (error) {
                console.error('Error sending email:', error);
                showToast('Email gönderilirken hata oluştu: ' + error.message, 'error');
            } finally {
                const btnId = testOnly ? 'testEmailBtn' : 'sendEmailBtn';
                const btn = document.getElementById(btnId);
                btn.disabled = false;
                btn.innerHTML = testOnly 
                    ? '<i class="fas fa-vial"></i> Test Gönderimi'
                    : '<i class="fas fa-paper-plane"></i> Tüm Abonelere Gönder';
            }
        }

        function previewEmail() {
            const articleId = document.getElementById('emailArticleSelect').value;
            const customMessage = document.getElementById('customMessage').value;
            const template = document.getElementById('emailTemplate').value;
            
            if (!articleId) {
                showToast('Önizleme için makale seçin', 'error');
                return;
            }
            
            const article = articlesData.find(a => a.id == articleId);
            if (!article) return;
            
            const preview = document.getElementById('emailPreviewContent');
            preview.innerHTML = generateEmailTemplate(article, customMessage, template);
        }

        function generateEmailTemplate(article, customMessage, template) {
            let templateStyle = '';
            let titleColor = '#d9534f';
            
            if (template === 'weekly_digest') {
                templateStyle = 'border-left: 4px solid #007bff; background: #f0f8ff;';
                titleColor = '#007bff';
            } else if (template === 'important_alert') {
                templateStyle = 'border-left: 4px solid #ff0000; background: #fff5f5;';
                titleColor = '#ff0000';
            }
            
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; padding: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #00cc00; padding-bottom: 15px; margin-bottom: 25px; }
                        .article-card { padding: 20px; border-radius: 10px; margin: 20px 0; ${templateStyle} }
                        .btn { background: #00cc00; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold; }
                        .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; font-size: 12px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Adem Bayazıt</h1>
                        <p>Cybersecurity Articles</p>
                    </div>
                    
                    <h2>Yeni Makale Yayınlandı</h2>
                    
                    <div class="article-card">
                        <h3 style="color: ${titleColor}; margin-top: 0;">${article.title}</h3>
                        
                        ${article.title_tr ? `<h4>${article.title_tr}</h4>` : ''}
                        
                        <p><strong>Kategori:</strong> ${article.category}</p>
                        <p><strong>Yayın Tarihi:</strong> ${new Date(article.published_date || article.date).toLocaleDateString('tr-TR')}</p>
                        <p><strong>Görüntülenme:</strong> ${article.views || 0}</p>
                        <p><strong>Beğeni:</strong> ${article.likes || 0}</p>
                        
                        ${customMessage ? `
                        <div style="background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 15px 0;">
                            <strong>Özel Mesaj:</strong> ${customMessage}
                        </div>
                        ` : ''}
                        
                        <p><strong>Özet:</strong> ${article.content.substring(0, 200).replace(/<[^>]*>/g, '')}...</p>
                        
                        <a href="https://adembayazit.com/article#${article.id}" class="btn">
                            Makaleyi Oku
                        </a>
                    </div>
                    
                    <div class="footer">
                        <p>Bu email'i Adem Bayazıt'ın Cybersecurity Articles aboneliğinden aldınız.</p>
                        <p>
                            <a href="https://adembayazit.com/unsubscribe" style="color: #666;">Abonelikten Çık</a> | 
                            <a href="https://adembayazit.com/articles" style="color: #666;">Tüm Makaleler</a>
                        </p>
                    </div>
                </body>
                </html>
            `;
        }

        function generateTextTemplate(article, customMessage) {
            return `
YENİ MAKALE: ${article.title}

${article.title_tr ? `Türkçe Başlık: ${article.title_tr}` : ''}

Kategori: ${article.category}
Yayın Tarihi: ${new Date(article.published_date || article.date).toLocaleDateString('tr-TR')}
Görüntülenme: ${article.views || 0}
Beğeni: ${article.likes || 0}

${customMessage ? `Özel Mesaj: ${customMessage}\n\n` : ''}

Özet: ${article.content.substring(0, 200).replace(/<[^>]*>/g, '')}...

Makaleyi okumak için: https://adembayazit.com/articles#${article.id}

---
Adem Bayazıt - Cybersecurity Articles
Abonelikten çıkmak için: https://adembayazit.com/unsubscribe
            `;
        }

        // Settings Functions
        async function saveSettings() {
            showToast('Ayarlar kaydedildi', 'success');
        }

        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                showToast('Lütfen tüm alanları doldurun', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('Şifreler eşleşmiyor', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showToast('Şifre en az 6 karakter olmalı', 'error');
                return;
            }
            
            const hash = await sha256(newPassword);
            
            // Update config
            CONFIG.ADMIN_PASSWORD_HASH = hash;
            localStorage.setItem('adminPasswordHash', hash);
            
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            showToast('Şifre başarıyla değiştirildi', 'success');
        }

        function createBackup() {
            const backup = {
                articles: articlesData,
                subscribers: subscribersData,
                createdAt: new Date().toISOString(),
                version: '1.0'
            };
            
            const backupStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([backupStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('lastBackup').value = new Date().toLocaleString('tr-TR');
            showToast('Yedekleme oluşturuldu', 'success');
        }

        function exportData() {
            const data = {
                articles: articlesData,
                subscribers: subscribersData
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'articles-data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('JSON verisi indirildi', 'success');
        }

        // Initialize Admin Panel
        function showAdminPanel() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            
            // Initialize components
            initEditor();
            setupNavigation();
            
            // Load initial data
            loadDashboard();
            
            // Setup event listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // Save draft button
            document.getElementById('saveDraftBtn').addEventListener('click', saveDraft);
            
            // Publish article button
            document.getElementById('publishArticleBtn').addEventListener('click', () => saveArticle(true));
            
            // Refresh preview button
            document.getElementById('refreshPreview').addEventListener('click', function() {
                const articleData = getArticleFormData();
                const preview = document.getElementById('articlePreview');
                preview.innerHTML = `
                    <h3>${articleData.title || 'Başlıksız'}</h3>
                    ${articleData.title_tr ? `<h4>${articleData.title_tr}</h4>` : ''}
                    <p><strong>Kategori:</strong> ${articleData.category || 'Belirtilmemiş'}</p>
                    <p><strong>Yazar:</strong> ${articleData.author}</p>
                    <p><strong>Okuma Süresi:</strong> ${articleData.reading_time} dakika</p>
                    <hr>
                    <div>${articleData.content || 'İçerik yok'}</div>
                    ${articleData.content_tr ? `<hr><h4>Türkçe İçerik:</h4><div>${articleData.content_tr}</div>` : ''}
                `;
                showToast('Önizleme yenilendi', 'info');
            });
            
            // Add subscriber button
            document.getElementById('addSubscriberBtn').addEventListener('click', async function() {
                const email = document.getElementById('addSubscriberEmail').value.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (!emailRegex.test(email)) {
                    showToast('Geçerli bir email adresi girin', 'error');
                    return;
                }
                
                try {
                    await loadSubscribers();
                    
                    if (subscribersData.some(s => s.email === email)) {
                        showToast('Bu email zaten abone', 'warning');
                        return;
                    }
                    
                    const newSubscriber = {
                        email: email,
                        subscribedAt: new Date().toISOString(),
                        status: 'active'
                    };
                    
                    subscribersData.push(newSubscriber);
                    
                    const dataToSave = {
                        subscribers: subscribersData,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    await fetchViaProxy('', 'PUT', dataToSave, CONFIG.SUBSCRIBERS_BIN_ID);
                    
                    document.getElementById('addSubscriberEmail').value = '';
                    showToast('Abone eklendi', 'success');
                    loadSubscribers();
                } catch (error) {
                    console.error('Error adding subscriber:', error);
                    showToast('Abone eklenirken hata oluştu', 'error');
                }
            });
            
            // Export subscribers button
            document.getElementById('exportSubscribersBtn').addEventListener('click', function() {
                const csv = 'Email,Kayıt Tarihi,Durum\n' + 
                    subscribersData.map(s => 
                        `${s.email},${s.subscribedAt || new Date().toISOString()},${s.status || 'active'}`
                    ).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'subscribers.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Abone listesi indirildi', 'success');
            });
            
            // Email buttons
            document.getElementById('testEmailBtn').addEventListener('click', () => sendEmailToSubscribers(true));
            document.getElementById('sendEmailBtn').addEventListener('click', () => {
                showConfirm('Tüm abonelere email göndermek istediğinizden emin misiniz?', () => sendEmailToSubscribers(false));
            });
            document.getElementById('previewEmailBtn').addEventListener('click', previewEmail);
            document.getElementById('refreshEmailStats').addEventListener('click', loadEmailSection);
            
            // Settings buttons
            document.getElementById('saveGeneralSettings').addEventListener('click', saveSettings);
            document.getElementById('saveSecuritySettings').addEventListener('click', changePassword);
            document.getElementById('createBackupBtn').addEventListener('click', createBackup);
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            
            // Modal close buttons
            document.getElementById('closePreview').addEventListener('click', () => hideModal('previewModal'));
            
            // Load draft if available
            loadDraft();
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already authenticated
            if (checkAuth()) {
                showAdminPanel();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
            }
            
            // Setup login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Setup logout button
            document.getElementById('logoutBtn')?.addEventListener('click', function() {
                showConfirm('Çıkış yapmak istediğinizden emin misiniz?', logout);
            });
            
            // Close modals when clicking outside
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    hideModal(event.target.id);
                }
                if (event.target.classList.contains('crop-modal')) {
                    document.getElementById('cropModal').classList.remove('active');
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                }
            });
            
            // Handle escape key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    hideModal('previewModal');
                    hideModal('confirmModal');
                    const cropModal = document.getElementById('cropModal');
                    if (cropModal.classList.contains('active')) {
                        cropModal.classList.remove('active');
                        if (cropper) {
                            cropper.destroy();
                            cropper = null;
                        }
                    }
                    if (window.innerWidth <= 992 && isSidebarOpen) {
                        closeSidebar();
                    }
                }
            });
            
            // Auto-focus password field
            document.getElementById('adminPassword')?.focus();
        });
    </script>
</body>
</html>